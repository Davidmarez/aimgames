// ==UserScript==
// @name        AIM Enhanced
// @description Improves posting on AIM. Adds partial markdown support and other fun stuff.
// @namespace   notareal@em.ail
// @require     https://code.jquery.com/jquery-3.1.1.min.js
// @require     http://codemirror.net/lib/codemirror.js
// @require     http://codemirror.net/mode/css/css.js
// @require     http://codemirror.net/mode/xml/xml.js
// @require     http://codemirror.net/mode/vbscript/vbscript.js
// @require     http://codemirror.net/mode/javascript/javascript.js
// @require     http://codemirror.net/mode/htmlmixed/htmlmixed.js
// @require     https://github.com/rosmanov/CodeMirror-modes/raw/master/bbcode/bbcode.js
// @require     https://github.com/rosmanov/CodeMirror-modes/raw/master/bbcodemixed/bbcodemixed.js
// @require     https://github.com/enyo/opentip/raw/master/downloads/opentip-native.js
// @require     https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/editorbuttons.js
// @require     https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/prism.js
// @resource    codemirrorBaseCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/codemirror-base.css
// @resource    codemirrorThemeCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/codemirror-theme.css
// @resource    prismCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/prism.css
// @include     http://aimgames.forummotion.com/post
// @include     http://aimgames.forummotion.com/post*
// @include     http://aimgames.forummotion.com/t*
// @include     http://aimgames.forummotion.com/f*
// @include     http://aimgames.forummotion.com/
// @version     0.38
// @grant       GM_addStyle
// @grant       GM_log
// @grant       GM_info
// @grant       GM_getResourceText
// @grant       GM_setClipboard
// @license     MIT License (Expat); opensource.org/licenses/MIT
// ==/UserScript==
'use strict';GM_log(GM_info);"use strict";GM_addStyle(GM_getResourceText("codemirrorBaseCSS"));GM_addStyle(GM_getResourceText("codemirrorThemeCSS"));GM_addStyle(GM_getResourceText("prismCSS"));var e={};function f(a,b){var c=a.s(),d=c.o();c.D(b,d)}
function g(a){var b=document.createElement("span");buttons.forEach(function(c){if("string"==typeof c){var d=document.createElement("img");d.src=c;d.style="vertical-align:middle";b.appendChild(d)}else{var n=c.id,d=k(n,c.src,c.i);c.l?d.addEventListener("click",function(){f(a,"["+c.tag+"]")}):d.addEventListener("click",function(){e[n]?(e[n]=!1,f(a,"[/"+c.tag+"]")):(e[n]=!0,f(a,"["+c.tag+"]"))});b.appendChild(d)}b.appendChild(document.createTextNode("\u00a0"))});return b}
function k(a,b,c){var d=document.createElement("button");d.setAttribute("accesskey",c);d.setAttribute("type","button");d.setAttribute("id",a);d.setAttribute("title","");d.setAttribute("class","button2");a=document.createElement("img");a.setAttribute("src",b);d.appendChild(a);return d}GM_addStyle("\n\n/* clear default bbcode buttons */\n#text_edit, #html_edit, #text_editor_cmd_switchmode, #format-buttons > img, #format-buttons > wbr {\n  display: none !important;\n}\n#format-buttons {\n  padding-bottom: 5px;\n}\n\n/*anotha padding fix*/\n#quick_reply > table > tbody > tr > td > .CodeMirror {\n  margin-top: 5px;\n}\n\n/*tooltip font*/\n.opentip-container {\n  font-family: Verdana,Arial,Helvetica,sans-serif;\n}\n\n/*makes my name be rainbow-y*/\n[href=\"/u2548\"] > span > strong{\n    animation: hansencolorRotate 6s linear 0s infinite;\n}\n\n@keyframes hansencolorRotate {\n    from {\n        color: rgb(255, 0, 0);\n    }\n    16.6% {\n        color: rgb(255, 0, 255);\n    }\n    33.3% {\n        color: rgb(0, 0, 255);\n    }\n    50% {\n        color: rgb(0, 255, 255);\n    }\n    66.6% {\n        color: rgb(0, 255, 0);\n    }\n    83.3% {\n        color: rgb(255, 255, 0);\n    }\n    to {\n        color: rgb(255, 0, 0);\n    }\n}\n\n\n/*slight padding below post buttons for tidiness*/\n.post-options {\n  padding-bottom: 2.5px;\n}\n/*hovering over post buttons*/\n.post-options > a:hover {\n  background-color: #fbfbfb !important;\n  \n  background: linear-gradient(to bottom, rgb(201, 31, 31) 0%,rgb(140, 14, 14) 100%) !important;\n  border-image: linear-gradient(to bottom, rgb(47, 47, 47) 0%,rgb(87, 87, 87) 100%) 1 !important;\n}\n/*remove default button imgs*/\n.post-options > a > img {\n  display: none;\n}\n/*remove broken multiquote button*/\n.post-options > img {\n  display: none; \n}\n/*edit button text*/\n.post-options > a[href$=\"mode=editpost\"]:after {\n  display: initial;\n  content: 'edit';\n}\n/*delete button text*/\n.post-options > a[href$=\"mode=delete\"]:after {\n  display: initial;\n  content: 'x';\n}\n/*quote button text*/\n.post-options > a[href$=\"mode=quote\"]:after {\n  display: initial;\n  content: 'quote';\n}\n/*show IP button text*/\n.post-options > a[href^=\"/modcp?mode=ip\"]:after {\n  display: initial;\n  content: 'ip';\n}\n/*post buttons*/\n.post-options > a {\n  font: 11px Arial, Helvetica, sans-serif;\n  \n  /*! a-shadow: inset 0 1px 0 rgba(255,255,255,.3), 0 1px 0 rgba(0,0,0,.1); */\n\n  position: relative;\n  vertical-align: middle;\n  margin: 0 2px 5px 0;\n  background-color: #940b0b;\n  border: solid 3px #272727;\n\n  background-repeat: no-repeat;\n  background-position: center center;\n  text-indent: -900em;\n  color: #333;\n  text-decoration: none;\n  line-height: 100%;\n  white-space: nowrap;\n\n  -webkit-border-radius: 0px;\n  -moz-border-radius: 0px;\n  border-radius: 0px;\n\n\n  width: 26px;\n  height: 26px;\n  font-size: 90%;\n\n  visibility: initial;\n  display: initial;\n  padding: 2px 5px;\n  text-align: center;\n  font-size: 75%;\n  /*! margin-bottom: 0; */\n  /*! margin-top: 100px; */\n  \n  /*transition: all 1s ease;*/\n  color: #d0b2b2;\n  text-transform: uppercase;\n  font-weight: bold;\n  background: linear-gradient(to bottom, rgb(163, 22, 22) 0%,rgb(105, 10, 10) 100%);\n  border-image: linear-gradient(to bottom, rgb(20, 20, 20) 0%,rgb(62, 62, 62) 100%) 1;\n  /*! border-style: solid; */\n  /*! border-width: 10px; */\n  /*! -webkit-font-smoothing: antialiased; */\n  text-shadow: 1px 1px 1px rgba(0,0,0,0.004);\n  text-rendering: optimizeLegibility;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  \n  /*could remove i suppose?*/\n  font-size: 60%;\n}\n\n/*tiny fix for bottom categories bar*/\n.catBottom {\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n/*hide the text-footer at the bottom of the screen*/\n#page-footer {\n  display:none;\n}\n\n/*utility class for links*/\n.hansenAnc {\n  cursor: pointer;\n  font-weight: bold;\n  text-decoration: none;\n}\n/*no underline*/\n.hansenAnc:hover {\n  text-decoration: none !important;\n}\n\n/*legacy syntax highlighting CSS*/\n.code {\n  color: #eee;\n}\n.hansen-literal {\n  color: #CC3366 !important;\n}\n.hansen-keyword {\n  color: #33FFFF !important;\n}\n\n/*prismjs 'bug' fix*/\n/*.language-java {*/\n.cont_code {\n  white-space: pre !important;\n}\n/*style fix*/\n/*.code {*/\n.code:not(.spoiler) {\n  background: #272822 !important;\n}\n");
function l(a){a=CodeMirror.m(a,{mode:"bbcodemixed",H:2,v:2,w:!1,A:!0,B:!0,F:"native",autofocus:!0});a.G(700,250);if(document.getElementById("text_editor_controls"))document.getElementById("format-buttons").appendChild(g(a));else{var b=document.getElementById("text_editor_textarea");b&&(b=b.parentElement,b.insertBefore(g(a),b.firstChild))}}
var m='<style type="text/css">\npre {\n    max-height: 200px;\n    overflow: auto;\n    /**/\n    color: #ff6913;\n    font-family: Courier,"Courier New","Source Code Pro",monospace;\n    font-size: 11px;\n    /* box */\n    background-color: #000;\n    border: solid 1px #1c1c1c;\n    margin: 0;\n    /* possibly? */\n    margin-left: 60px;\n}\n/* inline code, shit that isnt deprecated in html5 */\nsamp {\n    color: #ff6913;\n    font-family: Courier,"Courier New","Source Code Pro",monospace;\n}\n</style>'.replace(/^\s+/gm,"").replace(/(\r\n|\n)/g,
"").replace(/\/\*([^]+?)\*\//g,""),p=document.getElementById("text_editor_textarea");
p&&(p.value&&"<"===p.value[0]||(p.value=m+"\n"+p.value),document.addEventListener("keydown",function(a){13==a.which&&(p.value=p.value.replace(/\[cd\]([^]+?)\[\/cd\]/g,"<pre>$1</pre>").replace(/`([^]+?)`/g,"<samp>$1</samp>"))},!1),window.h.f?(console.log("sceditor"),delete $.f,l(p)):window.j?(console.log("cmeditor"),editor.I(),l(p)):(console.log("?? editor"),window.addEventListener("load",function(){var a=document.getElementsByClassName("sceditor-container");a&&a[0]?a[0].remove():console.log("cl is "+
a);(a=document.getElementById("text_editor_textarea"))?l(a):console.log("org is "+a)})));for(var q=document.getElementsByClassName("post-options"),r=0,t=q.length;r<t;r++){var u=q[r].querySelector("img").id,u=u.substring(u.lastIndexOf("_")+1);$(q[r]).C('<a href="'+document.location.origin+document.location.pathname+"#"+u+'">Link to this post</a>')}
function v(a){var b="";Array.slice(a.getElementById("profile-advanced-details").children).forEach(function(a){"DL"==a.tagName&&(b+=a.children[0].textContent+a.children[1].textContent+"\n")});return b.replace(/Male.*$/m,(a.querySelector(".ajax-profil_parent > .field_uneditable > img")||{alt:"Unknown"}).alt).replace(/\*/g,"").replace(/\s*:\s*/gm,": ").replace(/Birthday: (....-..-..).*$/m,"Birthday: $1").trim().replace(/\n/g,"<br>").replace(/([A-Za-z \/]+): ([A-Za-z \/]+): /g,"$1: -<br>$2: ").replace(/([A-Za-z \/]+): ([A-Za-z \/]+): /g,
"$1: -<br>$2: ")}var w=-1,x=null,y=null;function z(a,b,c,d){return function(){y&&(clearTimeout(y),y=null);y=setTimeout(function(){w===b&&x?(a.a(x),a.show()):(a.a("Loading..."),a.show(),$.get(c,function(c){c=(new DOMParser).parseFromString(c,"text/html");c=d(c);a.a(c);x=c;w=b;console.log("Load was performed.")}))},1E3)}}function A(a){return function(){y&&(clearTimeout(y),y=null);a.b()}}function B(a){return function(){y&&(clearTimeout(y),y=null);a.b()}}
for(var C=document.querySelectorAll('a[href^="/u"]'),D=0,E=C.length;D<E;D++){var F=D,G=C[D],H=new Opentip(G,{g:null,c:"mouseleave",style:"dark"});G.addEventListener("mouseover",z(H,F,G.href,v));G.addEventListener("mouseleave",A(H));G.addEventListener("mouseout",B(H))}
function I(a){a=a.querySelector("tr.post > td:nth-child(2) > table:nth-child(1) > tbody:nth-child(1) > tr:nth-child(3) > td:nth-child(1) > div:nth-child(1) > div:nth-child(1)");if(null===a)return"(N/A)";a=a.textContent;return 500>a.length?a:a.substr(0,500)}
for(var J=document.querySelectorAll("a.topictitle"),K=0,E=J.length;K<E;K++){var L=K+C.length,M=J[K],N=new Opentip(M,{g:null,c:"mouseleave",style:"dark"});M.addEventListener("mouseover",z(N,L,M.href,I));M.addEventListener("mouseleave",A(N));M.addEventListener("mouseout",B(N))}var O=document.querySelectorAll(".codebox:not(.spoiler)");
function P(a){return a.replace(/\&lt;/g,"<").replace(/\&gt;/g,">").replace(/\&nbsp;/g,"").replace(/\&amp;/g,"&").replace(/<br>/g,"\r\n").replace(/<span class=\"token [a-z]+\"( spellcheck=\"true\")?>/g,"").replace(/<\/span>/g,"")}
for(var Q={content:void 0},R=0,E=O.length;R<E;Q={content:Q.content},R++){var S=O[R].children[0];Q.content=O[R].children[1].children[0];if(Q.content){var T=document.createElement("a");T.appendChild(document.createTextNode(" Select All"));T.setAttribute("class","genmed hansenAnc");T.addEventListener("click",function(a){return function(){var b=a.content;if(document.selection){var c=document.body.createTextRange();c.moveToElementText(b);c.select()}else window.getSelection&&(c=document.createRange(),c.selectNode(b),
window.getSelection().addRange(c))}}(Q));S.appendChild(T);var U=document.createElement("a");U.appendChild(document.createTextNode(" Copy"));U.setAttribute("class","genmed hansenAnc");U.addEventListener("click",function(a){return function(){try{GM_setClipboard(P(a.content.innerHTML))}catch(b){GM_setClipboard(a.content.textContent)}}}(Q));S.appendChild(U)}}
function V(){try{for(var a=document.getElementsByClassName("cont_code"),b=0,c=a.length;b<c;b++){if(!a[b]){console.log("undef:"+b);setTimeout(V,200);break}a[b].innerHTML=Prism.u(P(a[b].innerHTML),Prism.languages.java)}}catch(d){console.error(d),console.error(d.toString())}}window.addEventListener("load",function(){V()},!1);