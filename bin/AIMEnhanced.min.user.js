// ==UserScript==
// @name        AIM Enhanced
// @description Improves posting on AIM. Adds partial markdown support and other fun stuff.
// @namespace   notareal@em.ail
// @require     https://code.jquery.com/jquery-3.1.1.min.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/codemirror.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/css.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/xml.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/vbscript.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/javascript.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/htmlmixed.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/bbcode.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/bbcodemixed.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/opentip-native.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/editorbuttons.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/prism.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/usernamehistory.js
// @resource    codemirrorBaseCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/codemirror-base.css
// @resource    codemirrorThemeCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/codemirror-theme.css
// @resource    prismCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/prism.css
// @include     http://aimgames.forummotion.com/post
// @include     http://aimgames.forummotion.com/post*
// @include     http://aimgames.forummotion.com/t*
// @include     http://aimgames.forummotion.com/f*
// @include     http://aimgames.forummotion.com/
// @version     0.47
// @grant       GM_addStyle
// @grant       GM_log
// @grant       GM_info
// @grant       GM_getResourceText
// @grant       GM_setClipboard
// @license     MIT License (Expat); opensource.org/licenses/MIT
// ==/UserScript==
'use strict';GM_log(GM_info);GM_addStyle(GM_getResourceText("codemirrorBaseCSS"));GM_addStyle(GM_getResourceText("codemirrorThemeCSS"));GM_addStyle(GM_getResourceText("prismCSS"));var e={};function f(a,d){var b=a.u(),c=b.s();b.G(d,c)}
function g(){var a=h,d=document.createElement("span");buttons.forEach(function(b){if("string"==typeof b){var c=document.createElement("img");c.src=b;c.style="vertical-align:middle";d.appendChild(c)}else{var m=b.id,c=k(m,b.src,b.j);b.m?c.addEventListener("click",function(){f(a,"["+b.tag+"]")}):c.addEventListener("click",function(){e[m]?(e[m]=!1,f(a,"[/"+b.tag+"]")):(e[m]=!0,f(a,"["+b.tag+"]"))});d.appendChild(c)}d.appendChild(document.createTextNode("\u00a0"))});return d}
function k(a,d,b){var c=document.createElement("button");c.setAttribute("accesskey",b);c.setAttribute("type","button");c.setAttribute("id",a);c.setAttribute("title","");c.setAttribute("class","button2");a=document.createElement("img");a.setAttribute("src",d);c.appendChild(a);return c}GM_addStyle("\n\n/* clear default bbcode buttons */\n#text_edit, #html_edit, #text_editor_cmd_switchmode, #format-buttons > img, #format-buttons > wbr {\n  display: none !important;\n}\n#format-buttons {\n  padding-bottom: 5px;\n}\n\n/*anotha padding fix*/\n#quick_reply > table > tbody > tr > td > .CodeMirror {\n  margin-top: 5px;\n}\n\n/*tooltip font*/\n.opentip-container {\n  font-family: Verdana,Arial,Helvetica,sans-serif;\n}\n\n/*makes my name be rainbow-y*/\n[href=\"/u2548\"] > span > strong{\n    animation: hansencolorRotate 6s linear 0s infinite;\n}\n\n@keyframes hansencolorRotate {\n    from {\n        color: rgb(255, 0, 0);\n    }\n    16.6% {\n        color: rgb(255, 0, 255);\n    }\n    33.3% {\n        color: rgb(0, 0, 255);\n    }\n    50% {\n        color: rgb(0, 255, 255);\n    }\n    66.6% {\n        color: rgb(0, 255, 0);\n    }\n    83.3% {\n        color: rgb(255, 255, 0);\n    }\n    to {\n        color: rgb(255, 0, 0);\n    }\n}\n\n\n/*slight padding below post buttons for tidiness*/\n.post-options {\n  padding-bottom: 2.5px;\n}\n/*hovering over post buttons*/\n.post-options > a:hover {\n  background-color: #fbfbfb !important;\n  \n  background: linear-gradient(to bottom, rgb(201, 31, 31) 0%,rgb(140, 14, 14) 100%) !important;\n  border-image: linear-gradient(to bottom, rgb(47, 47, 47) 0%,rgb(87, 87, 87) 100%) 1 !important;\n}\n/*remove default button imgs*/\n.post-options > a > img {\n  display: none;\n}\n/*remove broken multiquote button*/\n.post-options > img {\n  display: none; \n}\n/*edit button text*/\n.post-options > a[href$=\"mode=editpost\"]:after {\n  display: initial;\n  content: 'edit';\n}\n/*delete button text*/\n.post-options > a[href$=\"mode=delete\"]:after {\n  display: initial;\n  content: 'x';\n}\n/*quote button text*/\n.post-options > a[href$=\"mode=quote\"]:after {\n  display: initial;\n  content: 'quote';\n}\n/*show IP button text*/\n.post-options > a[href^=\"/modcp?mode=ip\"]:after {\n  display: initial;\n  content: 'ip';\n}\n/*post buttons*/\n.post-options > a {\n  font: 11px Arial, Helvetica, sans-serif;\n  \n  /*! a-shadow: inset 0 1px 0 rgba(255,255,255,.3), 0 1px 0 rgba(0,0,0,.1); */\n\n  position: relative;\n  vertical-align: middle;\n  margin: 0 2px 5px 0;\n  background-color: #940b0b;\n  border: solid 3px #272727;\n\n  background-repeat: no-repeat;\n  background-position: center center;\n  text-indent: -900em;\n  color: #333;\n  text-decoration: none;\n  line-height: 100%;\n  white-space: nowrap;\n\n  -webkit-border-radius: 0px;\n  -moz-border-radius: 0px;\n  border-radius: 0px;\n\n\n  width: 26px;\n  height: 26px;\n  font-size: 90%;\n\n  visibility: initial;\n  display: initial;\n  padding: 2px 5px;\n  text-align: center;\n  font-size: 75%;\n  /*! margin-bottom: 0; */\n  /*! margin-top: 100px; */\n  \n  /*transition: all 1s ease;*/\n  color: #d0b2b2;\n  text-transform: uppercase;\n  font-weight: bold;\n  background: linear-gradient(to bottom, rgb(163, 22, 22) 0%,rgb(105, 10, 10) 100%);\n  border-image: linear-gradient(to bottom, rgb(20, 20, 20) 0%,rgb(62, 62, 62) 100%) 1;\n  /*! border-style: solid; */\n  /*! border-width: 10px; */\n  /*! -webkit-font-smoothing: antialiased; */\n  text-shadow: 1px 1px 1px rgba(0,0,0,0.004);\n  text-rendering: optimizeLegibility;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  \n  /*could remove i suppose?*/\n  font-size: 60%;\n}\n\n/*tiny fix for bottom categories bar*/\n.catBottom {\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n/*hide the text-footer at the bottom of the screen*/\n#page-footer {\n  display:none;\n}\n\n/*utility class for links*/\n.hansenAnc {\n  cursor: pointer;\n  font-weight: bold;\n  text-decoration: none;\n}\n/*no underline*/\n.hansenAnc:hover {\n  text-decoration: none !important;\n}\n\n/*legacy syntax highlighting CSS*/\n.code {\n  color: #eee;\n}\n.hansen-literal {\n  color: #CC3366 !important;\n}\n.hansen-keyword {\n  color: #33FFFF !important;\n}\n\n/*prismjs 'bug' fix*/\n/*.language-java {*/\n.cont_code {\n  white-space: pre !important;\n}\n/*style fix*/\n/*.code {*/\n.code:not(.spoiler) {\n  background: #272822 !important;\n}\n\n/* 'image has been scaled to fit screen' msg */\n/*fitimg is an anchor, that works w/ display:block*/\n.h-fitimg {\n\tbackground-color: #231717;\n    padding-left: 5px;\n    padding-right: 5px;\n    /*width: 99.093%;*/\n\tcursor: pointer;\n\tborder: solid 1px #2F2929; /*chrome and shit*/\n\tborder: solid 1px #2F2929CC; /*modern firefox*/\n    display: block;\n}\n.h-fitimg:hover {\n    text-decoration: none !important;\n}\n/*resize the imgs themselvers*/\n.postbody > div > img {\n  max-width: 100%;\n}\n\n/*remastered icons*/\nimg[src=\"https://illiweb.com/fa/extremedarkred/navfolder.gif\"] {\n\tbackground-image: url('http://i.imgur.com/MCyr6Y1.png');\n\tobject-position: -20px 20px;\n\tbackground-size: cover;\n  margin-right: 2px;\n}\n\nimg[src=\"https://illiweb.com/fa/extremedarkred/icon_minipost.gif\"] {\n  background-image: url('http://i.imgur.com/jat1H4q.png');\n  object-position: -20px 20px;\n  background-size: cover;\n  /*margin-right: 2px;*/\n\n  vertical-align: 0px;\n  margin-right: 0px;\n}\n\nimg[src=\"http://i71.servimg.com/u/f71/14/03/33/42/locked12.gif\"] {\n  background-image: url('http://i.imgur.com/DXwHC1o.png'); /*also url('http://i.imgur.com/u3StReB.png');*/\n  object-position: -20px 20px;\n  background-size: cover;\n  margin-right: 2px;\n\n  vertical-align: -1px;\n}\n\nimg[src=\"https://illiweb.com/fa/extremedarkred/icon_minipost_new.gif\"] {\n    background-image: url('http://i.imgur.com/JLJvZpG.png');\n    object-position: -20px 20px;\n    background-size: cover;\n    /*margin-right: 2px;*/\n\n    vertical-align: 0px;\n    margin-right: 0px;\n}\n\nimg[title][src=\"http://i59.servimg.com/u/f59/14/03/33/42/catego12.png\"] {\n    background-image: url('http://i.imgur.com/DumidY4.png');\n    object-position: -40px 20px;\n    background-size: cover;\n    /*margin-right: 2px;*/\n\n    vertical-align: 0px;\n    margin-right: 0px;\n}\n\n/*category title spacing fix*/\n.cattitle {\n    padding-left: 2px;\n}\n");
var h=void 0;function n(a){h=CodeMirror.o(a,{mode:"bbcodemixed",J:2,A:2,B:!1,C:!0,D:!0,H:"native",autofocus:!1});h.I(700,250);if(document.getElementById("text_editor_controls"))document.getElementById("format-buttons").appendChild(g());else if(a=document.getElementById("text_editor_textarea"))a=a.parentElement,a.insertBefore(g(),a.firstChild)}
var aa='<style type="text/css">\npre {\n    max-height: 200px;\n    overflow: auto;\n    /**/\n    color: #ff6913;\n    font-family: Courier,"Courier New","Source Code Pro",monospace;\n    font-size: 11px;\n    /* box */\n    background-color: #000;\n    border: solid 1px #1c1c1c;\n    margin: 0;\n    /* possibly? */\n    margin-left: 60px;\n}\n/* inline code, shit that isnt deprecated in html5 */\nsamp {\n    color: #ff6913;\n    font-family: Courier,"Courier New","Source Code Pro",monospace;\n}\n</style>'.replace(/^\s+/gm,"").replace(/(\r\n|\n)/g,
"").replace(/\/\*([^]+?)\*\//g,"");function p(){var a=h.v();a&&"<"===a[0]||(a=aa+"\n"+a);return a.replace(/\[cd\]([^]+?)\[\/cd\]/g,"<pre>$1</pre>").replace(/`([^]+?)`/g,"<samp>$1</samp>").replace(/\[gist\]([^]+?)\[\/gist\]/g,'<iframe src="http://rafa1231518.github.io/nfmm-addons/embed.html?loc=$1" name="aframe1" scrolling="auto" frameborder="no" align="left" width="100%"></iframe>')}var q=document.getElementById("text_editor_textarea");
if(q){var r=document.querySelector(".liteoption[name=preview]");r&&r.addEventListener("click",function(){h.g(p());console.log("clicked!!!")});var t=document.querySelector(".mainoption[name=post]");t&&t.addEventListener("click",function(){h.g(p());console.log("clicked!!!")});window.i.f?(console.log("sceditor"),delete $.f,n(q)):window.l?(console.log("cmeditor"),h.K(),n(q)):(console.log("?? editor"),window.addEventListener("load",function(){var a=document.getElementsByClassName("sceditor-container");
a&&a[0]?a[0].remove():console.log("cl is "+a);(a=document.getElementById("text_editor_textarea"))?n(a):console.log("org is "+a)}))}for(var u=document.getElementsByClassName("post-options"),v=0,ba=u.length;v<ba;v++){var w=u[v].querySelector("img").id,w=w.substring(w.lastIndexOf("_")+1);$(u[v]).F('<a href="'+document.location.origin+document.location.pathname+"#"+w+'">Link to this post</a>')}
function ca(a){var d=a.getElementById("profile-advanced-details"),b="";try{var c=a.querySelectorAll(".genmed.module-title")[0].textContent.trim().replace(/ \(online\)/,""),b="Username history: "+(usernameHistory[c]||c)+"<br>"}catch(m){b="Username history: "+m+"<br>"}Array.slice(d.children).forEach(function(a){"DL"==a.tagName&&(b+=a.children[0].textContent+a.children[1].textContent+"\n")});return b.replace(/Male.*$/m,(a.querySelector(".ajax-profil_parent > .field_uneditable > img")||{alt:"Unknown"}).alt).replace(/\*/g,
"").replace(/\s*:\s*/gm,": ").replace(/Birthday: (....-..-..).*$/m,"Birthday: $1").trim().replace(/\n/g,"<br>").replace(/([A-Za-z \/]+): ([A-Za-z \/]+): /g,"$1: -<br>$2: ").replace(/([A-Za-z \/]+): ([A-Za-z \/]+): /g,"$1: -<br>$2: ")}var x=-1,y=null,z=null;
function A(a,d,b,c){return function(){z&&(clearTimeout(z),z=null);z=setTimeout(function(){x===d&&y?(a.a(y),a.show()):(a.a("Loading..."),a.show(),$.get(b,function(b){b=(new DOMParser).parseFromString(b,"text/html");b=c(b);a.a(b);y=b;x=d;console.log("Load was performed.")}))},1E3)}}function B(a){return function(){z&&(clearTimeout(z),z=null);a.b()}}function C(a){return function(){z&&(clearTimeout(z),z=null);a.b()}}
for(var D=document.querySelectorAll('a[href^="/u"]'),E=0,F=D.length;E<F;E++){var da=E,G=D[E],H=new Opentip(G,{h:null,c:"mouseleave",style:"dark"});G.addEventListener("mouseover",A(H,da,G.href,ca));G.addEventListener("mouseleave",B(H));G.addEventListener("mouseout",C(H))}
function ea(a){a=a.querySelector("tr.post > td:nth-child(2) > table:nth-child(1) > tbody:nth-child(1) > tr:nth-child(3) > td:nth-child(1) > div:nth-child(1) > div:nth-child(1)");if(null===a)return"(N/A)";a=a.textContent;return 500>a.length?a:a.substr(0,500)}
for(var I=document.querySelectorAll("a.topictitle"),J=0,F=I.length;J<F;J++){var fa=J+D.length,K=I[J],L=new Opentip(K,{h:null,c:"mouseleave",style:"dark"});K.addEventListener("mouseover",A(L,fa,K.href,ea));K.addEventListener("mouseleave",B(L));K.addEventListener("mouseout",C(L))}var M=document.querySelectorAll(".codebox:not(.spoiler)");
function N(a){return a.replace(/\&lt;/g,"<").replace(/\&gt;/g,">").replace(/\&nbsp;/g,"").replace(/\&amp;/g,"&").replace(/<br>/g,"\r\n").replace(/<span class=\"token [a-z]+\"( spellcheck=\"true\")?>/g,"").replace(/<\/span>/g,"")}
for(var O={content:void 0},P=0,F=M.length;P<F;O={content:O.content},P++){var Q=M[P].children[0];if("A"!=Q.firstChild.firstChild.firstChild.tagName&&(O.content=M[P].children[1].children[0],O.content)){var R=document.createElement("a");R.appendChild(document.createTextNode(" Select All"));R.setAttribute("class","genmed hansenAnc");R.addEventListener("click",function(a){return function(){var d=a.content;if(document.selection){var b=document.body.createTextRange();b.moveToElementText(d);b.select()}else window.getSelection&&
(b=document.createRange(),b.selectNode(d),window.getSelection().addRange(b))}}(O));Q.appendChild(R);var S=document.createElement("a");S.appendChild(document.createTextNode(" Copy"));S.setAttribute("class","genmed hansenAnc");S.addEventListener("click",function(a){return function(){try{GM_setClipboard(N(a.content.innerHTML))}catch(d){GM_setClipboard(a.content.textContent)}}}(O));Q.appendChild(S)}}
function T(){try{for(var a=document.getElementsByClassName("cont_code"),d=0,b=a.length;d<b;d++){if(!a[d]){console.log("undef:"+d);setTimeout(T,200);break}a[d].innerHTML=Prism.w(N(a[d].innerHTML),Prism.languages.java)}}catch(c){console.error(c),console.error(c.toString())}}window.addEventListener("load",function(){T()},!1);
for(var U=document.querySelectorAll(".postbody > div > img"),V=0,F=U.length;V<F;V++)if(0<U[V].clientWidth&&U[V].naturalWidth!==U[V].clientWidth){var W=document.createElement("a");W.setAttribute("class","h-fitimg");W.setAttribute("href",U[V].src);W.appendChild(document.createTextNode("Image scaled to fit screen. Click to show original size..."));U[V].parentElement.insertBefore(W,U[V])}
for(var X=document.querySelectorAll('a[href*="/http"]'),Y=0,F=X.length;Y<F;Y++){var Z=X[Y].href.substring(X[Y].href.indexOf("/http")+1);X[Y].setAttribute("href",Z);X[Y].textContent=Z};