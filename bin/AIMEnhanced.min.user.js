// ==UserScript==
// @name        AIM Enhanced
// @description Improves posting on AIM. Adds partial markdown support and other fun stuff.
// @namespace   notareal@em.ail
// @require     https://code.jquery.com/jquery-3.1.1.min.js
// @require     http://codemirror.net/lib/codemirror.js
// @require     http://codemirror.net/mode/css/css.js
// @require     http://codemirror.net/mode/xml/xml.js
// @require     http://codemirror.net/mode/vbscript/vbscript.js
// @require     http://codemirror.net/mode/javascript/javascript.js
// @require     http://codemirror.net/mode/htmlmixed/htmlmixed.js
// @require     https://github.com/rosmanov/CodeMirror-modes/raw/master/bbcode/bbcode.js
// @require     https://github.com/rosmanov/CodeMirror-modes/raw/master/bbcodemixed/bbcodemixed.js
// @require     https://github.com/enyo/opentip/raw/master/downloads/opentip-native.js
// @require     https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/editorbuttons.js
// @resource    codemirrorBaseCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/codemirror-base.css
// @resource    codemirrorThemeCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/codemirror-theme.css
// @include     http://aimgames.forummotion.com/post
// @include     http://aimgames.forummotion.com/post*
// @include     http://aimgames.forummotion.com/t*
// @include     http://aimgames.forummotion.com/f*
// @include     http://aimgames.forummotion.com/
// @version     0.27
// @grant       GM_addStyle
// @grant       GM_log
// @grant       GM_info
// @grant       GM_getResourceText
// @license     MIT License (Expat); opensource.org/licenses/MIT
// ==/UserScript==
'use strict';GM_log(GM_info);"use strict";GM_addStyle(GM_getResourceText("codemirrorBaseCSS"));GM_addStyle(GM_getResourceText("codemirrorThemeCSS"));var e={};function f(a,c){var b=a.s(),d=b.o();b.C(c,d)}
function g(a){var c=document.createElement("span");buttons.forEach(function(b){if("string"==typeof b){var d=document.createElement("img");d.src=b;d.style="vertical-align:middle";c.appendChild(d)}else{var l=b.id,d=k(l,b.src,b.i);b.l?d.addEventListener("click",function(){f(a,"["+b.tag+"]")}):d.addEventListener("click",function(){e[l]?(e[l]=!1,f(a,"[/"+b.tag+"]")):(e[l]=!0,f(a,"["+b.tag+"]"))});c.appendChild(d)}c.appendChild(document.createTextNode("\u00a0"))});return c}
function k(a,c,b){var d=document.createElement("button");d.setAttribute("accesskey",b);d.setAttribute("type","button");d.setAttribute("id",a);d.setAttribute("title","");d.setAttribute("class","button2");a=document.createElement("img");a.setAttribute("src",c);d.appendChild(a);return d}GM_addStyle('\n\n/* clear default bbcode buttons */\n#text_edit, #html_edit, #text_editor_cmd_switchmode, #format-buttons > img, #format-buttons > wbr {\n  display: none !important;\n}\n#format-buttons {\n  padding-bottom: 5px;\n}\n\n/*anotha padding fix*/\n#quick_reply > table > tbody > tr > td > .CodeMirror {\n  margin-top: 5px;\n}\n\n/*tooltip font*/\n.opentip-container {\n  font-family: Verdana,Arial,Helvetica,sans-serif;\n}\n\n/*makes my name be rainbow-y*/\n[href="/u2548"] > span > strong{\n    animation: hansencolorRotate 6s linear 0s infinite;\n}\n\n@keyframes hansencolorRotate {\n    from {\n        color: rgb(255, 0, 0);\n    }\n    16.6% {\n        color: rgb(255, 0, 255);\n    }\n    33.3% {\n        color: rgb(0, 0, 255);\n    }\n    50% {\n        color: rgb(0, 255, 255);\n    }\n    66.6% {\n        color: rgb(0, 255, 0);\n    }\n    83.3% {\n        color: rgb(255, 255, 0);\n    }\n    to {\n        color: rgb(255, 0, 0);\n    }\n}\n\n\n/*\n.i_icon_quote {\n}*/\n/*hovering over post buttons*/\n.post-options > a:hover {\n  background-color: #fbfbfb !important;\n  \n  background: linear-gradient(to bottom, rgb(201, 31, 31) 0%,rgb(140, 14, 14) 100%) !important;\n  border-image: linear-gradient(to bottom, rgb(47, 47, 47) 0%,rgb(87, 87, 87) 100%) 1 !important;\n}\n/*remove default button imgs*/\n.post-options > a > img {\n  display: none;\n}\n/*remove broken multiquote button*/\n.post-options > img {\n  display: none; \n}\n/*edit button text*/\n.post-options > a[href$="mode=editpost"]:after {\n  display: initial;\n  content: \'edit\';\n}\n/*delete button text*/\n.post-options > a[href$="mode=delete"]:after {\n  display: initial;\n  content: \'x\';\n}\n/*quote button text*/\n.post-options > a[href$="mode=quote"]:after {\n  display: initial;\n  content: \'quote\';\n}\n/*show IP button text*/\n.post-options > a[href^="/modcp?mode=ip"]:after {\n  display: initial;\n  content: \'ip\';\n}\n/*post buttons*/\n.post-options > a {\n  font: 11px Arial, Helvetica, sans-serif;\n  \n  /*! a-shadow: inset 0 1px 0 rgba(255,255,255,.3), 0 1px 0 rgba(0,0,0,.1); */\n\n  position: relative;\n  vertical-align: middle;\n  margin: 0 2px 5px 0;\n  background-color: #940b0b;\n  border: solid 3px #272727;\n\n  background-repeat: no-repeat;\n  background-position: center center;\n  text-indent: -900em;\n  color: #333;\n  text-decoration: none;\n  line-height: 100%;\n  white-space: nowrap;\n\n  -webkit-border-radius: 0px;\n  -moz-border-radius: 0px;\n  border-radius: 0px;\n\n\n  width: 26px;\n  height: 26px;\n  font-size: 90%;\n\n  visibility: initial;\n  display: initial;\n  padding: 2px 5px;\n  text-align: center;\n  font-size: 75%;\n  /*! margin-bottom: 0; */\n  /*! margin-top: 100px; */\n  \n  /*transition: all 1s ease;*/\n  color: #d0b2b2;\n  text-transform: uppercase;\n  font-weight: bold;\n  background: linear-gradient(to bottom, rgb(163, 22, 22) 0%,rgb(105, 10, 10) 100%);\n  border-image: linear-gradient(to bottom, rgb(20, 20, 20) 0%,rgb(62, 62, 62) 100%) 1;\n  /*! border-style: solid; */\n  /*! border-width: 10px; */\n  /*! -webkit-font-smoothing: antialiased; */\n  text-shadow: 1px 1px 1px rgba(0,0,0,0.004);\n  text-rendering: optimizeLegibility;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  \n  /*could remove i suppose?*/\n  font-size: 60%;\n}\n\n/*tiny fix for bottom categories bar*/\n.catBottom {\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n/*hide the text-footer at the bottom of the screen*/\n#page-footer {\n  display:none;\n}\n');
function m(a){a=CodeMirror.m(a,{mode:"bbcodemixed",G:2,u:2,v:!1,w:!0,A:!0,D:"native",autofocus:!0});a.F(700,250);if(document.getElementById("text_editor_controls"))document.getElementById("format-buttons").appendChild(g(a));else{var c=document.getElementById("text_editor_textarea");c&&(c=c.parentElement,c.insertBefore(g(a),c.firstChild))}}
var n='<style type="text/css">\npre {\n    max-height: 200px;\n    overflow: auto;\n    /**/\n    color: #ff6913;\n    font-family: Courier,"Courier New","Source Code Pro",monospace;\n    font-size: 11px;\n    /* box */\n    background-color: #000;\n    border: solid 1px #1c1c1c;\n    margin: 0;\n    /* possibly? */\n    margin-left: 60px;\n}\n/* inline code, shit that isnt deprecated in html5 */\nsamp {\n    color: #ff6913;\n    font-family: Courier,"Courier New","Source Code Pro",monospace;\n}\n</style>'.replace(/^\s+/gm,"").replace(/(\r\n|\n)/g,
"").replace(/\/\*([^]+?)\*\//g,""),p=document.getElementById("text_editor_textarea");
p&&(p.value&&"<"===p.value[0]||(p.value=n+"\n"+p.value),document.addEventListener("keydown",function(a){13==a.which&&(p.value=p.value.replace(/\[cd\]([^]+?)\[\/cd\]/g,"<pre>$1</pre>").replace(/`([^]+?)`/g,"<samp>$1</samp>"))},!1),window.h.f?(console.log("sceditor"),delete $.f,m(p)):window.j?(console.log("cmeditor"),editor.H(),m(p)):(console.log("?? editor"),window.addEventListener("load",function(){var a=document.getElementsByClassName("sceditor-container");a&&a[0]?a[0].remove():console.log("cl is "+
a);(a=document.getElementById("text_editor_textarea"))?m(a):console.log("org is "+a)})));for(var q=document.getElementsByClassName("post-options"),r=0,t=q.length;r<t;r++){var u=q[r].querySelector("img").id,u=u.substring(u.lastIndexOf("_")+1);$(q[r]).B('<a href="'+document.location.origin+document.location.pathname+"#"+u+'">Link to this post</a>')}
function v(a){var c="";Array.slice(a.getElementById("profile-advanced-details").children).forEach(function(a){"DL"==a.tagName&&(c+=a.children[0].textContent+a.children[1].textContent+"\n")});return c.replace(/Male.*$/m,(a.querySelector(".ajax-profil_parent > .field_uneditable > img")||{alt:"Unknown"}).alt).replace(/\*/g,"").replace(/\s*:\s*/gm,": ").replace(/Birthday: (....-..-..).*$/m,"Birthday: $1").trim().replace(/\n/g,"<br>").replace(/([A-Za-z \/]+): ([A-Za-z \/]+): /g,"$1: -<br>$2: ").replace(/([A-Za-z \/]+): ([A-Za-z \/]+): /g,
"$1: -<br>$2: ")}var w=-1,x=null,y=null;function z(a,c,b,d){return function(){y&&(clearTimeout(y),y=null);y=setTimeout(function(){w===c&&x?(a.a(x),a.show()):(a.a("Loading..."),a.show(),$.get(b,function(b){b=(new DOMParser).parseFromString(b,"text/html");b=d(b);a.a(b);x=b;w=c;console.log("Load was performed.")}))},1E3)}}function A(a){return function(){y&&(clearTimeout(y),y=null);a.b()}}function B(a){return function(){y&&(clearTimeout(y),y=null);a.b()}}
for(var C=document.querySelectorAll('a[href^="/u"]'),D=0,E=C.length;D<E;D++){var F=D,G=C[D],H=new Opentip(G,{g:null,c:"mouseleave",style:"dark"});G.addEventListener("mouseover",z(H,F,G.href,v));G.addEventListener("mouseleave",A(H));G.addEventListener("mouseout",B(H))}
function I(a){a=a.querySelector("tr.post > td:nth-child(2) > table:nth-child(1) > tbody:nth-child(1) > tr:nth-child(3) > td:nth-child(1) > div:nth-child(1) > div:nth-child(1)");if(null===a)return"(N/A)";a=a.textContent;return 500>a.length?a:a.substr(0,500)}
for(var J=document.querySelectorAll("a.topictitle"),K=0,E=J.length;K<E;K++){var L=K+C.length,M=J[K],N=new Opentip(M,{g:null,c:"mouseleave",style:"dark"});M.addEventListener("mouseover",z(N,L,M.href,I));M.addEventListener("mouseleave",A(N));M.addEventListener("mouseout",B(N))};