// ==UserScript==
// @name        AIM Enhanced
// @description Improves posting on AIM. Adds partial markdown support and other fun stuff.
// @namespace   notareal@em.ail
// @require     https://code.jquery.com/jquery-3.1.1.min.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/codemirror.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/css.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/xml.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/vbscript.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/javascript.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/htmlmixed.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/bbcode.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/bbcodemixed.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/opentip-native.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/editorbuttons.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/prism.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/usernamehistory.js
// @require     https://raw.githubusercontent.com/HulaSamsquanch/aimgames/master/enhance/resources/swearifyLite.js
// @resource    codemirrorBaseCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/codemirror-base.css
// @resource    codemirrorThemeCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/codemirror-theme.css
// @resource    prismCSS https://github.com/HulaSamsquanch/aimgames/raw/master/enhance/prism.css
// @include     http://aimgames.forummotion.com/post
// @include     http://aimgames.forummotion.com/post*
// @include     http://aimgames.forummotion.com/t*
// @include     http://aimgames.forummotion.com/f*
// @include     http://aimgames.forummotion.com/
// @version     0.49
// @grant       GM_addStyle
// @grant       GM_log
// @grant       GM_info
// @grant       GM_getResourceText
// @grant       GM_setClipboard
// @license     MIT License (Expat); opensource.org/licenses/MIT
// ==/UserScript==
'use strict';GM_log(GM_info);GM_addStyle(GM_getResourceText("codemirrorBaseCSS"));GM_addStyle(GM_getResourceText("codemirrorThemeCSS"));GM_addStyle(GM_getResourceText("prismCSS"));var f={};function g(a,e){var c=a.v(),d=c.u();c.H(e,d)}
function h(){var a=k,e=document.createElement("span");buttons.forEach(function(c){if("string"==typeof c){var d=document.createElement("img");d.src=c;d.style="vertical-align:middle";e.appendChild(d)}else{var p=c.id,d=aa(p,c.src,c.j);c.o?d.addEventListener("click",function(){g(a,"["+c.tag+"]")}):d.addEventListener("click",function(){f[p]?(f[p]=!1,g(a,"[/"+c.tag+"]")):(f[p]=!0,g(a,"["+c.tag+"]"))});e.appendChild(d)}e.appendChild(document.createTextNode("\u00a0"))});return e}
function aa(a,e,c){var d=document.createElement("button");d.setAttribute("accesskey",c);d.setAttribute("type","button");d.setAttribute("id",a);d.setAttribute("title","");d.setAttribute("class","button2");a=document.createElement("img");a.setAttribute("src",e);d.appendChild(a);return d}GM_addStyle("\n\n/* clear default bbcode buttons */\n#text_edit, #html_edit, #text_editor_cmd_switchmode, #format-buttons > img, #format-buttons > wbr {\n  display: none !important;\n}\n#format-buttons {\n  padding-bottom: 5px;\n}\n\n/*anotha padding fix*/\n#quick_reply > table > tbody > tr > td > .CodeMirror {\n  margin-top: 5px;\n}\n\n/*tooltip font*/\n.opentip-container {\n  font-family: Verdana,Arial,Helvetica,sans-serif;\n}\n\n/*makes my name be rainbow-y*/\n[href=\"/u2548\"] > span > strong{\n    animation: hansencolorRotate 6s linear 0s infinite;\n}\n\n@keyframes hansencolorRotate {\n    from {\n        color: rgb(255, 0, 0);\n    }\n    16.6% {\n        color: rgb(255, 0, 255);\n    }\n    33.3% {\n        color: rgb(0, 0, 255);\n    }\n    50% {\n        color: rgb(0, 255, 255);\n    }\n    66.6% {\n        color: rgb(0, 255, 0);\n    }\n    83.3% {\n        color: rgb(255, 255, 0);\n    }\n    to {\n        color: rgb(255, 0, 0);\n    }\n}\n\n\n/*slight padding below post buttons for tidiness*/\n.post-options {\n  padding-bottom: 2.5px;\n}\n/*hovering over post buttons*/\n.post-options > a:hover {\n  background-color: #fbfbfb !important;\n  \n  background: linear-gradient(to bottom, rgb(201, 31, 31) 0%,rgb(140, 14, 14) 100%) !important;\n  border-image: linear-gradient(to bottom, rgb(47, 47, 47) 0%,rgb(87, 87, 87) 100%) 1 !important;\n}\n/*remove default button imgs*/\n.post-options > a > img {\n  display: none;\n}\n/*remove broken multiquote button*/\n.post-options > img {\n  display: none; \n}\n/*edit button text*/\n.post-options > a[href$=\"mode=editpost\"]:after {\n  display: initial;\n  content: 'edit';\n}\n/*delete button text*/\n.post-options > a[href$=\"mode=delete\"]:after {\n  display: initial;\n  content: 'x';\n}\n/*quote button text*/\n.post-options > a[href$=\"mode=quote\"]:after {\n  display: initial;\n  content: 'quote';\n}\n/*show IP button text*/\n.post-options > a[href^=\"/modcp?mode=ip\"]:after {\n  display: initial;\n  content: 'ip';\n}\n/*post buttons*/\n.post-options > a {\n  font: 11px Arial, Helvetica, sans-serif;\n  \n  /*! a-shadow: inset 0 1px 0 rgba(255,255,255,.3), 0 1px 0 rgba(0,0,0,.1); */\n\n  position: relative;\n  vertical-align: middle;\n  margin: 0 2px 5px 0;\n  background-color: #940b0b;\n  border: solid 3px #272727;\n\n  background-repeat: no-repeat;\n  background-position: center center;\n  text-indent: -900em;\n  color: #333;\n  text-decoration: none;\n  line-height: 100%;\n  white-space: nowrap;\n\n  -webkit-border-radius: 0px;\n  -moz-border-radius: 0px;\n  border-radius: 0px;\n\n\n  width: 26px;\n  height: 26px;\n  font-size: 90%;\n\n  visibility: initial;\n  display: initial;\n  padding: 2px 5px;\n  text-align: center;\n  font-size: 75%;\n  /*! margin-bottom: 0; */\n  /*! margin-top: 100px; */\n  \n  /*transition: all 1s ease;*/\n  color: #d0b2b2;\n  text-transform: uppercase;\n  font-weight: bold;\n  background: linear-gradient(to bottom, rgb(163, 22, 22) 0%,rgb(105, 10, 10) 100%);\n  border-image: linear-gradient(to bottom, rgb(20, 20, 20) 0%,rgb(62, 62, 62) 100%) 1;\n  /*! border-style: solid; */\n  /*! border-width: 10px; */\n  /*! -webkit-font-smoothing: antialiased; */\n  text-shadow: 1px 1px 1px rgba(0,0,0,0.004);\n  text-rendering: optimizeLegibility;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  \n  /*could remove i suppose?*/\n  font-size: 60%;\n}\n\n/*tiny fix for bottom categories bar*/\n.catBottom {\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n/*hide the text-footer at the bottom of the screen*/\n#page-footer {\n  display:none;\n}\n\n/*utility class for links*/\n.hansenAnc {\n  cursor: pointer;\n  font-weight: bold;\n  text-decoration: none;\n}\n/*no underline*/\n.hansenAnc:hover {\n  text-decoration: none !important;\n}\n\n/*legacy syntax highlighting CSS*/\n.code {\n  color: #eee;\n}\n.hansen-literal {\n  color: #CC3366 !important;\n}\n.hansen-keyword {\n  color: #33FFFF !important;\n}\n\n/*prismjs 'bug' fix*/\n/*.language-java {*/\n.cont_code {\n  white-space: pre !important;\n}\n/*style fix*/\n/*.code {*/\n.code:not(.spoiler) {\n  background: #272822 !important;\n}\n\n/* 'image has been scaled to fit screen' msg */\n/*fitimg is an anchor, that works w/ display:block*/\n.h-fitimg {\n\tbackground-color: #231717;\n    padding-left: 5px;\n    padding-right: 5px;\n    /*width: 99.093%;*/\n\tcursor: pointer;\n\tborder: solid 1px #2F2929; /*chrome and shit*/\n\tborder: solid 1px #2F2929CC; /*modern firefox*/\n    display: block;\n}\n.h-fitimg:hover {\n    text-decoration: none !important;\n}\n/*resize the imgs themselvers*/\n.postbody > div > img {\n  max-width: 100%;\n}\n\n/*remastered icons*/\nimg[src=\"https://illiweb.com/fa/extremedarkred/navfolder.gif\"] {\n\tbackground-image: url('http://i.imgur.com/MCyr6Y1.png');\n\tobject-position: -20px 20px;\n\tbackground-size: cover;\n  margin-right: 2px;\n}\n\nimg[src=\"https://illiweb.com/fa/extremedarkred/icon_minipost.gif\"] {\n  background-image: url('http://i.imgur.com/jat1H4q.png');\n  object-position: -20px 20px;\n  background-size: cover;\n  /*margin-right: 2px;*/\n\n  vertical-align: 0px;\n  margin-right: 0px;\n}\n\nimg[src=\"http://i71.servimg.com/u/f71/14/03/33/42/locked12.gif\"] {\n  background-image: url('http://i.imgur.com/DXwHC1o.png'); /*also url('http://i.imgur.com/u3StReB.png');*/\n  object-position: -20px 20px;\n  background-size: cover;\n  margin-right: 2px;\n\n  vertical-align: -1px;\n}\n\nimg[src=\"https://illiweb.com/fa/extremedarkred/icon_minipost_new.gif\"] {\n    background-image: url('http://i.imgur.com/JLJvZpG.png');\n    object-position: -20px 20px;\n    background-size: cover;\n    /*margin-right: 2px;*/\n\n    vertical-align: 0px;\n    margin-right: 0px;\n}\n\nimg[title][src=\"http://i59.servimg.com/u/f59/14/03/33/42/catego12.png\"] {\n    background-image: url('http://i.imgur.com/DumidY4.png');\n    object-position: -40px 20px;\n    background-size: cover;\n    /*margin-right: 2px;*/\n\n    vertical-align: 0px;\n    margin-right: 0px;\n}\n\n/*category title spacing fix*/\n.cattitle {\n    padding-left: 2px;\n}\n");
var k=void 0;
function n(a){a.value=a.value.replace(q,"").replace(/<(\/)?pre>/g,"[$1cd]").replace(/<\/?samp>/g,"`").replace(/<iframe src="http:\/\/rafa1231518\.github\.io\/nfmm-addons\/embed\.html?loc=(.*?)" name="aframe1" scrolling="auto" frameborder="no" align="left" width="100%"><\/iframe>/g,"[gist]$1[/gist]");k=CodeMirror.s(a,{mode:"bbcodemixed",L:2,B:2,C:!1,D:!0,F:!0,I:"native",autofocus:!1});k.J(700,250);if(document.getElementById("text_editor_controls"))document.getElementById("format-buttons").appendChild(h());else if(a=
document.getElementById("text_editor_textarea"))a=a.parentElement,a.insertBefore(h(),a.firstChild)}
var q='<style type="text/css">\npre {\n    max-height: 200px;\n    overflow: auto;\n    /**/\n    color: #ff6913;\n    font-family: Courier,"Courier New","Source Code Pro",monospace;\n    font-size: 11px;\n    /* box */\n    background-color: #000;\n    border: solid 1px #1c1c1c;\n    margin: 0;\n    /* possibly? */\n    margin-left: 60px;\n}\n/* inline code, shit that isnt deprecated in html5 */\nsamp {\n    color: #ff6913;\n    font-family: Courier,"Courier New","Source Code Pro",monospace;\n}\n</style>'.replace(/^\s+/gm,"").replace(/(\r\n|\n)/g,
"").replace(/\/\*([^]+?)\*\//g,"");function r(){var a=k.w();(a=(window.b?window.b.K:swearifyLite)(a))&&"<"===a[0]||(a=q+a);return a.replace(/\[cd\]([^]+?)\[\/cd\]/g,"<pre>$1</pre>").replace(/`([^]+?)`/g,"<samp>$1</samp>").replace(/\[gist\]([^]+?)\[\/gist\]/g,'<iframe src="http://rafa1231518.github.io/nfmm-addons/embed.html?loc=$1" name="aframe1" scrolling="auto" frameborder="no" align="left" width="100%"></iframe>')}var t=document.getElementById("text_editor_textarea");
if(t){var u=document.querySelector(".liteoption[name=preview]");u&&u.addEventListener("click",function(){k.h(r());console.log("clicked!!!")});var v=document.querySelector(".mainoption[name=post]");v&&v.addEventListener("click",function(){k.h(r());console.log("clicked!!!")});window.l.g?(console.log("sceditor"),delete $.g,n(t)):window.m?(console.log("cmeditor"),k.M(),n(t)):(console.log("?? editor"),window.addEventListener("load",function(){var a=document.getElementsByClassName("sceditor-container");
a&&a[0]?a[0].remove():console.log("cl is "+a);(a=document.getElementById("text_editor_textarea"))?n(a):console.log("org is "+a)}))}for(var w=document.getElementsByClassName("post-options"),x=0,ba=w.length;x<ba;x++){var y=w[x].querySelector("img").id,y=y.substring(y.lastIndexOf("_")+1);$(w[x]).G('<a href="'+document.location.origin+document.location.pathname+"#"+y+'">Link to this post</a>')}
function ca(a){var e=a.getElementById("profile-advanced-details"),c="";try{var d=a.querySelectorAll(".genmed.module-title")[0].textContent.trim().replace(/ \(online\)/,""),c="Username history: "+(usernameHistory[d]||d)+"<br>"}catch(p){c="Username history: "+p+"<br>"}Array.slice(e.children).forEach(function(a){"DL"==a.tagName&&(c+=a.children[0].textContent+a.children[1].textContent+"\n")});return c.replace(/Male.*$/m,(a.querySelector(".ajax-profil_parent > .field_uneditable > img")||{alt:"Unknown"}).alt).replace(/\*/g,
"").replace(/\s*:\s*/gm,": ").replace(/Birthday: (....-..-..).*$/m,"Birthday: $1").trim().replace(/\n/g,"<br>").replace(/([A-Za-z \/]+): ([A-Za-z \/]+): /g,"$1: -<br>$2: ").replace(/([A-Za-z \/]+): ([A-Za-z \/]+): /g,"$1: -<br>$2: ")}var z=-1,A=null,B=null;
function C(a,e,c,d){return function(){B&&(clearTimeout(B),B=null);B=setTimeout(function(){z===e&&A?(a.a(A),a.show()):(a.a("Loading..."),a.show(),$.get(c,function(c){c=(new DOMParser).parseFromString(c,"text/html");c=d(c);a.a(c);A=c;z=e;console.log("Load was performed.")}))},1E3)}}function D(a){return function(){B&&(clearTimeout(B),B=null);a.c()}}function E(a){return function(){B&&(clearTimeout(B),B=null);a.c()}}
for(var F=document.querySelectorAll('a[href^="/u"]'),G=0,H=F.length;G<H;G++){var da=G,I=F[G],J=new Opentip(I,{i:null,f:"mouseleave",style:"dark"});I.addEventListener("mouseover",C(J,da,I.href,ca));I.addEventListener("mouseleave",D(J));I.addEventListener("mouseout",E(J))}
function ea(a){a=a.querySelector("tr.post > td:nth-child(2) > table:nth-child(1) > tbody:nth-child(1) > tr:nth-child(3) > td:nth-child(1) > div:nth-child(1) > div:nth-child(1)");if(null===a)return"(N/A)";a=a.textContent;return 500>a.length?a:a.substr(0,500)}
for(var K=document.querySelectorAll("a.topictitle"),L=0,H=K.length;L<H;L++){var fa=L+F.length,M=K[L],N=new Opentip(M,{i:null,f:"mouseleave",style:"dark"});M.addEventListener("mouseover",C(N,fa,M.href,ea));M.addEventListener("mouseleave",D(N));M.addEventListener("mouseout",E(N))}var O=document.querySelectorAll(".codebox:not(.spoiler)");
function P(a){return a.replace(/\&lt;/g,"<").replace(/\&gt;/g,">").replace(/\&nbsp;/g,"").replace(/\&amp;/g,"&").replace(/<br>/g,"\r\n").replace(/<span class=\"token [a-z]+\"( spellcheck=\"true\")?>/g,"").replace(/<\/span>/g,"")}
for(var Q={content:void 0},R=0,H=O.length;R<H;Q={content:Q.content},R++){var S=O[R].children[0];if("A"!=S.firstChild.firstChild.firstChild.tagName&&(Q.content=O[R].children[1].children[0],Q.content)){var T=document.createElement("a");T.appendChild(document.createTextNode(" Select All"));T.setAttribute("class","genmed hansenAnc");T.addEventListener("click",function(a){return function(){var e=a.content;if(document.selection){var c=document.body.createTextRange();c.moveToElementText(e);c.select()}else window.getSelection&&
(c=document.createRange(),c.selectNode(e),window.getSelection().addRange(c))}}(Q));S.appendChild(T);var U=document.createElement("a");U.appendChild(document.createTextNode(" Copy"));U.setAttribute("class","genmed hansenAnc");U.addEventListener("click",function(a){return function(){try{GM_setClipboard(P(a.content.innerHTML))}catch(e){GM_setClipboard(a.content.textContent)}}}(Q));S.appendChild(U)}}
function ga(){try{for(var a=document.getElementsByClassName("cont_code"),e=0,c=a.length;e<c;e++){if(!a[e]){console.log("undef:"+e);setTimeout(ga,200);break}a[e].innerHTML=Prism.A(P(a[e].innerHTML),Prism.languages.java)}}catch(d){console.error(d),console.error(d.toString())}}window.addEventListener("load",function(){ga()},!1);
for(var V=document.querySelectorAll(".postbody > div > img"),W=0,H=V.length;W<H;W++)if(0<V[W].clientWidth&&V[W].naturalWidth!==V[W].clientWidth&&1321<V[W].naturalWidth){var X=document.createElement("a");X.setAttribute("class","h-fitimg");X.setAttribute("href",V[W].src);X.appendChild(document.createTextNode("Image scaled to fit screen. Click to show original size..."));V[W].parentElement.insertBefore(X,V[W])}
for(var Y=document.querySelectorAll('a[href*="/http"]'),Z=0,H=Y.length;Z<H;Z++){var ha=Y[Z].href.substring(Y[Z].href.indexOf("/http")+1);Y[Z].setAttribute("href",ha);Y[Z].textContent=ha};