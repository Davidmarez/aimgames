CodeMirror.defineMode("bbcodemixed",function(e){function t(e){return e.replace(/([\[\]\.\-\+\<\>\?\:\(\)\{\}])/g,"\\$1")}var l,a,o,n,i=CodeMirror.getMode(e,"htmlmixed"),r=CodeMirror.getMode(e,"bbcode"),l={bbCodeLiteral:"literal"};return e.hasOwnProperty("bbCodeLiteral")&&(l.bbCodeLiteral=e.bbCodeLiteral),a={hasLeftDelimeter:/.*\[/,htmlHasLeftDelimeter:/[^\<\>]*\[/,literalOpen:new RegExp(t("["+l.bbCodeLiteral+"]")),literalClose:new RegExp(t("[/"+l.bbCodeLiteral+"]"))},o={chain:function(e,t,l){return t.tokenize=l,l(e,t)},cleanChain:function(e,t,l){return t.tokenize=null,t.localState=null,t.localMode=null,"string"==typeof l?l?l:null:l(e,t)},maybeBackup:function(e,l,a){l=t(l);var o,n=e.current(),i=n.search(l);return i>-1?e.backUp(n.length-i):(o=n.match(/<\/?$/))&&(e.backUp(n.length),e.match(l,!1)||e.match(n[0])),a}},n={html:function(e,t){return!t.inLiteral&&e.match(a.htmlHasLeftDelimeter,!1)&&null===t.htmlMixedState.htmlState.tagName?(t.tokenize=n.bbcode,t.localMode=r,t.localState=r.startState(i.indent(t.htmlMixedState,"")),o.maybeBackup(e,"[",r.token(e,t.localState))):!t.inLiteral&&e.match("[",!1)?(t.tokenize=n.bbcode,t.localMode=r,t.localState=r.startState(i.indent(t.htmlMixedState,"")),o.maybeBackup(e,"[",r.token(e,t.localState))):i.token(e,t.htmlMixedState)},bbcode:function(e,t){return e.match("]",!1)?(e.eat("]"),t.tokenize=n.html,t.localMode=i,t.localState=t.htmlMixedState,"tag"):o.maybeBackup(e,"]",r.token(e,t.localState))},inBlock:function(e,t){return function(l,a){for(;!l.eol();){if(l.match(t)){o.cleanChain(l,a,"");break}l.next()}return e}}},{startState:function(){var e=i.startState();return{token:n.html,localMode:null,localState:null,htmlMixedState:e,tokenize:null,inLiteral:!1}},copyState:function(e){var t=null,l=e.tokenize||e.token;return e.localState&&(t=CodeMirror.copyState(l!=n.html?r:i,e.localState)),{token:e.token,tokenize:e.tokenize,localMode:e.localMode,localState:t,htmlMixedState:CodeMirror.copyState(i,e.htmlMixedState),inLiteral:e.inLiteral}},token:function(e,t){if(e.match("[",!1)){if(!t.inLiteral&&e.match(a.literalOpen,!0))return t.inLiteral=!0,"keyword";if(t.inLiteral&&e.match(a.literalClose,!0))return t.inLiteral=!1,"keyword"}t.inLiteral&&t.localState!=t.htmlMixedState&&(t.tokenize=n.html,t.localMode=i,t.localState=t.htmlMixedState);var l=(t.tokenize||t.token)(e,t);return l},indent:function(e,t){return e.localMode==r||e.inLiteral&&!e.localMode||a.hasLeftDelimeter.test(t)?CodeMirror.Pass:i.indent(e.htmlMixedState,t)},innerMode:function(e){return{state:e.localState||e.htmlMixedState,mode:e.localMode||i}}}},"htmlmixed"),CodeMirror.defineMIME("text/x-bbcode","bbcodemixed");